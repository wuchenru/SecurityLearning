
# Format String Vulnerability Summary

## What is a Format String Vulnerability?

A **format string vulnerability** occurs when user-controlled input is directly used in functions like `printf`, `fprintf`, or `sprintf` without proper formatting. This allows attackers to manipulate memory, potentially leading to **information disclosure** or **arbitrary code execution**.

---

## How Format Strings Work

Functions like `printf` parse format specifiers (e.g., `%d`, `%s`, `%x`) to format their output. If the number of format specifiers exceeds the number of provided arguments, the function reads unintended values from the **stack**, leading to **undefined behavior**.

---

## Exploitation Techniques

### 1. **Reading Memory**
Attackers can use `%x` or `%p` to dump memory from the stack, revealing sensitive data.

**Example:**
```c
printf(user_input); // User inputs: "%x %x %x"
```
If `user_input` is `%x %x %x`, the program prints three stack values.

---

### 2. **Writing Memory with `%n`**
The `%n` specifier writes the number of characters printed so far to a specified memory address, allowing attackers to overwrite data.

**Example:**
```c
printf("%n", &var); // Overwrites `var` with the number of printed characters.
```

---

### 3. **Payload Crafting**

- **Stack Exploration**: Use `%x` to dump stack values.
- **Memory Overwriting**: Combine `%n` with stack offsets (e.g., `%4$n`) to write to specific addresses.

**Example Payload:**
```bash
./vulnerable_program "$(python3 -c 'print "AAAA" + "%8$x"')"
```

---

## Memory Layout

Understanding memory layout is crucial for crafting attacks:
1. **Stack**: Local variables and function arguments.
   - Exploitable using `%x`, `%p`, `%n`.
2. **Heap**: Dynamically allocated memory.
3. **Global Data**: Stores global/static variables.
4. **Code Segment**: Program instructions.
   - Overwriting return addresses here can redirect execution.

---

## Exploit Workflow

1. **Identify Vulnerability**:
   - Find an unprotected `printf` or similar function:
     ```c
     printf(user_input);
     ```

2. **Dump Stack Data**:
   - Use `%x` or `%p` to locate sensitive memory addresses:
     ```bash
     ./vulnerable_program "%x %x %s"
     ```

3. **Overwrite Memory**:
   - Use `%n` to write controlled values to specific memory locations:
     ```bash
     ./vulnerable_program "$(python3 -c 'print "AAAA" + "%n"')"
     ```

---

## Mitigation Strategies

1. **Use Safe Functions**:
   - Replace `printf` with `snprintf` and always define the format string explicitly.

2. **Input Validation**:
   - Sanitize user input to remove unsafe characters.

3. **Compiler Protections**:
   - Enable warnings for format string issues (`-Wall -Wformat`).

4. **Runtime Protections**:
   - Enable **ASLR** (Address Space Layout Randomization) and stack canaries.

---

## Example Code

### Vulnerable Code:
```c
#include <stdio.h>

int main() {
    char user_input[100];
    gets(user_input); // Dangerous: allows buffer overflow
    printf(user_input); // Vulnerable: unprotected format string
    return 0;
}
```

### Exploitation:
1. Compile the code:
   ```bash
   gcc -o vulnerable vulnerable.c
   ```
2. Run with malicious input:
   ```bash
   ./vulnerable "%x %x %x %s"
   ```

---

### Secure Code:
```c
#include <stdio.h>

int main() {
    char user_input[100];
    fgets(user_input, sizeof(user_input), stdin); // Safe alternative to gets()
    printf("%s", user_input); // Explicit format string
    return 0;
}
```

---

## References
- [OWASP: Format String Vulnerability](https://owasp.org/www-community/attacks/Format_string_attack)
- [Exploit DB](https://www.exploit-db.com/)
